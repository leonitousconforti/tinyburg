import fs from "node:fs/promises";
import { runAgentOnRemote } from "@tinyburg/insight";

// Banner to put at the top of every data file
const sourceCodeBanner = `/**
 * This file was auto-generated by a frida agent
 *
 * Generated by: __filename
 * with TinyTower version: __version
 * on: __date
 */
`;

// To know where to put the generated source code
const AgentOutputFileMap = {
    "../src/data/bitbookPosts.ts": "BitbookAgent",
    "../src/data/bitizen.ts": "BitizenAgent",
    "../src/data/costumes.ts": "CostumeAgent",
    "../src/data/elevators.ts": "ElevatorAgent",
    "../src/data/floors.ts": "FloorAgent",
    "../src/data/missions.ts": "MissionAgent",
    "../src/data/pets.ts": "PetAgent",
    "../src/data/roofs.ts": "RoofAgent",
} as const;

// To add the filename that generated the source code into the source code
const AgentSourceFileMap = {
    BitbookAgent: "@tinyburg/insight/src/agents/get-bitbook-data.ts",
    BitizenAgent: "@tinyburg/insight/src/agents/get-bitizen-data.ts",
    CostumeAgent: "@tinyburg/insight/src/agents/get-costume-data.ts",
    ElevatorAgent: "@tinyburg/insight/src/agents/get-elevator-data.ts",
    FloorAgent: "@tinyburg/insight/src/agents/get-floor-data.ts",
    MissionAgent: "@tinyburg/insight/src/agents/get-mission-data.ts",
    PetAgent: "@tinyburg/insight/src/agents/get-pet-data.ts",
    RoofAgent: "@tinyburg/insight/src/agents/get-roof-data.ts",
} as const;

for (const [outputDestination, agent] of Object.entries(AgentOutputFileMap)) {
    console.log(`* Running agent: ${agent}`);
    const source = await runAgentOnRemote("host.docker.internal:27042", agent);
    const version = source.match(/TinyTower version: ([\d\.]+)/gm);

    const cleanedSource = source.replace(/\/\/ TinyTower version: ([\d\.]+)/gm, "");
    const formattedBanner = sourceCodeBanner
        .replace("__filename", AgentSourceFileMap[agent])
        .replace("__date", new Date().toUTCString())
        .replace("__version", version?.[0]?.split(":")[1]?.trim() || "unknown");

    const outputPath = new URL(outputDestination, import.meta.url);
    await fs.writeFile(outputPath, formattedBanner + cleanedSource);
    console.log(`* Done running agent: ${agent}`);
    console.log("---------------------------");
}
